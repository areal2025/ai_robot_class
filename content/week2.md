# 第2周：ROS2通信机制基础

**课时**: 6小时（第一次课3小时 + 第二次课3小时）

---

## 📋 本周课程表

| 次序 | 时间 | 主题 | 内容 |
|------|------|------|------|
| 第1次 | 3小时 | 核心概念深入 | 节点与话题深入理解、Pub/Sub模型 |
| 第2次 | 3小时 | 命令行实战 | 用命令行控制机器人画圆 |

---

## 第一次课：核心概念深入（3小时）

### ⏱️ 时间分配

| 环节 | 时间 | 内容 |
|------|------|------|
| 复习 | 20分钟 | 上周内容回顾、提问 |
| 深入概念1 | 40分钟 | 节点(Node)深入理解 |
| 深入概念2 | 50分钟 | 话题(Topic)深入理解 |
| 茶歇 | 10分钟 | 休息 |
| 演示 | 30分钟 | 探索Turtlesim的节点和话题 |
| 总结 | 30分钟 | 本周小结 |

---

## 1.1 节点深入理解（40分钟）

### 1.1.1 节点的特性

#### ① 单一职责

> **原则**：每个节点只做一件事

```
好例子：一个节点做一件事
┌─────────────────────────────────────────────┐
│  /camera_node       → 只管相机               │
│  /detection_node    → 只管检测               │
│  /navigation_node   → 只管导航               │
└─────────────────────────────────────────────┘

❌ 不好例子：一个节点做所有事
┌─────────────────────────────────────────────┐
│  /super_robot_node                         │
│  → 相机+检测+导航+控制+显示+...全部搞定    │
└─────────────────────────────────────────────┘
```

#### ② 独立运行

```
节点是独立的进程，互不干扰：

┌─────────────────────────────────────────────┐
│                                             │
│  进程A (/camera)    进程B (/detection)     │
│     │                     │                 │
│     ▼                     ▼                 │
│  相机驱动              目标检测              │
│     │                     │                 │
│     │                     │                 │
│  即使A崩溃，B继续运行！                       │
│                                             │
└─────────────────────────────────────────────┘
```

#### ③ 松耦合

```
松耦合 = 不需要知道对方在哪

发布者：                    订阅者：
┌────────────┐           ┌────────────┐
│ 我只管发布  │ ────────►│ 我只管订阅  │
│ 到/camera   │           │ /camera    │
└────────────┘           └────────────┘
    不需要知道                不需要知道
    谁在订阅                  谁在发布
```

### 1.1.2 节点的生命周期

```
节点状态机：

           ┌──────────┐
           │  未初始化  │
           └─────┬────┘
                 │ rclpy.init()
                 ▼
           ┌──────────┐
           │   初始    │ ◄──────────────┐
           └─────┬────┘                 │
                 │ create_node()        │
                 ▼                      │
           ┌──────────┐                 │
    ┌─────►│  运行中  │─────┐          │
│   │      └─────┬────┘     │          │
│   │            │         │          │destroy_node()
│   │        spin()        │          │
│   │            │         │          │
│   │            ▼         │          │
│   │      ┌──────────┐   │          │
│   │      │  销毁中   │───┘          │
│   │      └──────────┘                │
│   │            │                      │
│   │            ▼                      │
│   │      ┌──────────┐                 │
│   └──────│   已销毁  │◄────────────────
           └──────────┘
           
           rclpy.shutdown()
```

---

## 1.2 话题深入理解（50分钟）

### 1.2.1 话题的特性

#### ① 异步通信

```
异步 = 发布者不等订阅者

发布者：                    订阅者：
┌────────────┐           ┌────────────┐
│  碰碰碰    │ ────────►│  叮叮叮    │
│  (连续发布) │           │  (收到回调) │
└────────────┘           └────────────┘
    │                         │
    ▼                         ▼
 不等待                     收到就处理
 继续运行                  后再等待
```

#### ② 消息队列

```
队列大小 = 10

发布者 ──► [消息1] [消息2] [消息3] ... [消息10] ──► 订阅者
              ▲                                        │
              │                                        │
              │ 新消息                                  │ 消费
              └────────────────────────────────────────┘
              
如果订阅者处理太慢，队列只保留最近10条
```

### 1.2.2 消息类型详解

#### Twist消息（最常用的速度消息）

```python
# geometry_msgs/Twist 定义
# 文件位置: geometry_msgs/msg/Twist.msg

# 线性速度（单位：米/秒）
geometry_msgs/Vector3 linear
    float64 x    # 前进方向 +为前 -为后
    float64 y    # 侧向（差速机器人通常为0）
    float64 z    # 垂直（平面运动为0）

# 角速度（单位：弧度/秒）
geometry_msgs/Vector3 angular
    float64 x    # 滚转（平面运动为0）
    float64 y    # 俯仰（平面运动为0）
    float64 z    # 偏航 +为逆时针 -为顺时针
```

### 1.2.3 发布/订阅模型

```
数据流向：

   发布者节点                          订阅者节点
   ┌────────────┐                   ┌────────────┐
   │            │                   │            │
   │ create_    │   DDS网络          │ create_    │
   │ publisher  │◄─────────────────►│ subscriber │
   │ (/cmd_vel) │   (话题传输)        │ (/cmd_vel) │
   └─────┬──────┘                   └─────┬──────┘
         │                                 │
         ▼                                 ▼
   ┌────────────┐                   ┌────────────┐
   │ 发布Twist  │                   │ 回调函数   │
   │ 消息       │                   │ 处理消息   │
   └────────────┘                   └────────────┘
```

---

## 1.3 探索Turtlesim（30分钟）

### 演示1：查看节点

```bash
# 先启动Turtlesim（如果还没启动）
ros2 run turtlesim turtlesim_node

# 查看所有运行中的节点
ros2 node list

# 输出：
# /turtlesim
```

### 演示2：查看话题

```bash
# 查看所有话题
ros2 topic list

# 输出：
# /parameter_events
# /rosout
# /turtle1/cmd_vel        ← 速度命令
# /turtle1/color_sensor   ← 颜色传感器
# /turtle1/goal_vel       ← 目标速度
# /turtle1/pose           ← 位置坐标
```

### 演示3：监听话题

```bash
# 监听位置话题
ros2 topic echo /turtle1/pose

# 输出：
# x: 5.444444656
# y: 5.444444656
# theta: 0.0
# linear_velocity: 0.0
# angular_velocity: 0.0
```

---

## 第二次课：命令行实战（3小时）

### ⏱️ 时间分配

| 环节 | 时间 | 内容 |
|------|------|------|
| 复习 | 20分钟 | 提问巩固 |
| 讲解 | 40分钟 | 速度控制原理 |
| 演示 | 30分钟 | 命令行发布速度 |
| 实践 | 60分钟 | 画圆实验 |
| 茶歇 | 10分钟 | 休息 |
| 实践 | 60分钟 | 综合练习 |

---

## 2.1 速度控制原理（40分钟）

### 2.1.1 运动学基础

#### 重要公式

```
公式：圆周运动
┌─────────────────────────────────────┐
│           v = r × ω                │
│                                     │
│  其中：                             │
│  • v = 线速度 (m/s)                │
│  • r = 圆的半径 (m)                 │
│  • ω = 角速度 (rad/s)              │
│                                     │
│  推导：                             │
│  r = v / ω  (求半径)               │
│  ω = v / r  (求角速度)             │
└─────────────────────────────────────┘
```

#### 常用角度转换

| 角度 | 弧度 | 计算 |
|------|------|------|
| 360° | 2π ≈ 6.283 | 2 × 3.14159 |
| 180° | π ≈ 3.142 | 3.14159 |
| 90° | π/2 ≈ 1.571 | 3.14159 / 2 |
| 60° | π/3 ≈ 1.047 | 3.14159 / 3 |
| 45° | π/4 ≈ 0.785 | 3.14159 / 4 |

### 2.1.2 速度组合表

| 动作 | linear.x | angular.z | 效果 |
|------|----------|-----------|------|
| 直行前进 | 1.0 | 0.0 | 1m/s向前 |
| 直行后退 | -1.0 | 0.0 | 1m/s向后 |
| 原地左转 | 0.0 | 1.0 | 逆时针1rad/s |
| 原地右转 | 0.0 | -1.0 | 顺时针1rad/s |
| 前进左转 | 1.0 | 0.5 | 画圆（半径2m） |
| 停止 | 0.0 | 0.0 | 静止 |

### 2.1.3 数学计算示例

```
示例1：半径2米的圆
- 设定线速度 v = 2 m/s
- 半径 r = 2 m
- 角速度 ω = v / r = 2 / 2 = 1 rad/s
- 命令：linear.x=2.0, angular.z=1.0

示例2：每秒转一圈
- 周期 T = 1秒
- 角速度 ω = 2π / T = 2π ≈ 6.28 rad/s
- 命令：angular.z=6.28
```

---

## 2.2 命令行发布速度（30分钟）

### 基本语法

```bash
# 语法
ros2 topic pub <话题> <消息类型> <数据>

# 示例
ros2 topic pub /turtle1/cmd_vel geometry_msgs/Twist \
  "{linear: {x: 1.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"
```

---

## 2.3 画圆实验（60分钟）

### 实验1：基础画圆

```bash
# 让小乌龟画圆（前进 + 左转）
ros2 topic pub --rate 1 /turtle1/cmd_vel geometry_msgs/Twist \
  "{linear: {x: 2.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 1.0}}"
```

> 按 `Ctrl+C` 停止

### 实验2：不同半径

| 目标半径 | 线速度 | 角速度 | 命令参数 |
|---------|--------|--------|---------|
| 1米 | 1.0 m/s | 1.0 rad/s | x=1.0, z=1.0 |
| 2米 | 2.0 m/s | 1.0 rad/s | x=2.0, z=1.0 |
| 4米 | 2.0 m/s | 0.5 rad/s | x=2.0, z=0.5 |

### 实验3：顺时针画圆

```bash
# 顺时针转
ros2 topic pub --rate 1 /turtle1/cmd_vel geometry_msgs/Twist \
  "{linear: {x: 1.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: -1.0}}"
```

---

## 本周实验报告

### ✅ 验收清单

| 序号 | 实验 | 要求 | 完成 |
|------|------|------|------|
| 1 | 查看节点 | ros2 node list | ☐ |
| 2 | 查看话题 | ros2 topic list | ☐ |
| 3 | 监听话题 | ros2 topic echo /turtle1/pose | ☐ |
| 4 | 前进命令 | 小乌龟前进 | ☐ |
| 5 | 画圆 | 半径2米的圆 | ☐ |
| 6 | 顺时针 | 顺时针画圆 | ☐ |
| 7 | 旋转 | 原地转圈 | ☐ |
| 8 | 停止 | 发送停止命令 | ☐ |

---

## 本周作业

### 📝 理论题

1. 解释"发布者"和"订阅者"的区别
2. 如果要同时控制两个机器人，需要什么条件？

### 📐 计算题

已知：小乌龟线速度 1.5 m/s，角速度 0.75 rad/s
- 画出的圆半径是多少？
- 转一圈需要多少秒？

### 💻 实践题

1. 用命令行实现走正方形

---

## 知识点速查表

```
┌─────────────────────────────────────────────────────────────┐
│                    第2周知识点速查                           │
├─────────────────────────────────────────────────────────────┤
│  概念                                                          │
│  ├── Node = 独立运行的程序                                   │
│  ├── Topic = 异步通信频道                                     │
│  ├── Publisher = 发布者                                      │
│  ├── Subscriber = 订阅者                                    │
│  └── Twist = 速度消息类型                                    │
│      ├── linear.x = 线速度 (m/s)                            │
│      └── angular.z = 角速度 (rad/s)                         │
├─────────────────────────────────────────────────────────────┤
│  公式                                                          │
│  ├── v = r × ω                                              │
│  ├── r = v / ω                                              │
│  └── ω = v / r                                              │
├─────────────────────────────────────────────────────────────┤
│  命令                                                          │
│  ├── ros2 node list                                          │
│  ├── ros2 topic list                                         │
│  ├── ros2 topic echo <topic>                                 │
│  └── ros2 topic pub <topic> <type> <data>                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 下周预告

> **第3周：Python编程与机器人控制**
> - 编写第一个Python ROS2节点
> - 用代码控制小乌龟
> - 实现走正方形

---

*第2周结束！🚀*
